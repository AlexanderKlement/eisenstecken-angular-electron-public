<div class="i40-page">
  <div class="i40-toolbar">
    <div class="i40-title">
      <div class="i40-title__main">Industrie 4.0</div>
      <div class="i40-title__sub">Jobs verwalten (Ausstehend · Laufend · Abgeschlossen)</div>
    </div>

    <button mat-flat-button color="primary" type="button" (click)="createJobClicked()">
      Neuen Job erstellen
    </button>
  </div>

  @if (jobs$ | async; as jobs) {
    <mat-tab-group>
      <mat-tab label="Ausstehend ({{ jobs.pending.length }})">
        <div class="i40-table">
          <div class="i40-row i40-header">
            <div>Job-ID</div>
            <div>Datei</div>
            <div>Rezept</div>
            <div>Dicke</div>
            <div>Geplant</div>
            <div>Gut</div>
            <div>Ausschuss</div>
            <div>Total</div>
          </div>

          @for (job of jobs.pending; track job.job_id) {
            <div class="i40-row">
              <div class="mono">{{ job.job_id }}</div>
              <div class="truncate" title="{{ job.filename }}">{{ job.filename }}</div>
              <div class="num">{{ job.recipe }}</div>
              <div class="num">{{ job.thickness }}</div>
              <div class="num">{{ job.pieces_planned }}</div>
              <div class="num">{{ job.pieces_good ?? "—" }}</div>
              <div class="num">{{ job.pieces_scrap ?? "—" }}</div>
              <div class="num">{{ job.pieces_produced_total ?? "—" }}</div>
            </div>
          } @empty {
            <div class="i40-empty">Keine ausstehenden Jobs vorhanden.</div>
          }
        </div>
      </mat-tab>

      <mat-tab label="Laufend ({{ jobs.running.length }})">
        <div class="i40-table">
          <div class="i40-row i40-header">
            <div>Job-ID</div>
            <div>Datei</div>
            <div>Rezept</div>
            <div>Dicke</div>
            <div>Geplant</div>
            <div>Gut</div>
            <div>Ausschuss</div>
            <div>Total</div>
          </div>

          @for (job of jobs.running; track job.job_id) {
            <div class="i40-row">
              <div class="mono">{{ job.job_id }}</div>
              <div class="truncate" title="{{ job.filename }}">{{ job.filename }}</div>
              <div class="num">{{ job.recipe }}</div>
              <div class="num">{{ job.thickness }}</div>
              <div class="num">{{ job.pieces_planned }}</div>
              <div class="num">{{ job.pieces_good ?? "—" }}</div>
              <div class="num">{{ job.pieces_scrap ?? "—" }}</div>
              <div class="num">{{ job.pieces_produced_total ?? "—" }}</div>
            </div>
          } @empty {
            <div class="i40-empty">Keine laufenden Jobs vorhanden.</div>
          }
        </div>
      </mat-tab>

      <mat-tab label="Abgeschlossen ({{ jobs.completed.length }})">
        <div class="i40-table">
          <div class="i40-row i40-header">
            <div>Job-ID</div>
            <div>Datei</div>
            <div>Rezept</div>
            <div>Dicke</div>
            <div>Geplant</div>
            <div>Gut</div>
            <div>Ausschuss</div>
            <div>Total</div>
          </div>

          @for (job of jobs.completed; track job.job_id) {
            <div class="i40-row">
              <div class="mono">{{ job.job_id }}</div>
              <div class="truncate" title="{{ job.filename }}">{{ job.filename }}</div>
              <div class="num">{{ job.recipe }}</div>
              <div class="num">{{ job.thickness }}</div>
              <div class="num">{{ job.pieces_planned }}</div>
              <div class="num">{{ job.pieces_good ?? "—" }}</div>
              <div class="num">{{ job.pieces_scrap ?? "—" }}</div>
              <div class="num">{{ job.pieces_produced_total ?? "—" }}</div>
            </div>
          } @empty {
            <div class="i40-empty">Keine abgeschlossenen Jobs vorhanden.</div>
          }
        </div>
      </mat-tab>
      <mat-tab label="Log">
        <div class="i40-log-toolbar">
          <div class="i40-log-info">
            Zeige {{ logOffset + 1 }} – {{ logOffset + logLimit }}
          </div>

          <div class="i40-log-actions">
            <button mat-stroked-button type="button" (click)="prevLogPage()" [disabled]="logOffset === 0">
              Zurück
            </button>
            <button mat-stroked-button type="button" (click)="nextLogPage()" [disabled]="!hasNextLogPage">
              Weiter
            </button>
          </div>
        </div>

        @if (logs$ | async; as logs) {
          <div class="i40-table">
            <div class="i40-row i40-header i40-log-header">
              <div>ID</div>
              <div>Job-ID</div>
              <div>Status</div>
              <div>Zeitpunkt</div>
              <div>Gut</div>
              <div>Ausschuss</div>
            </div>

            @for (row of logs; track row.id) {
              <div class="i40-row i40-log-row">
                <div class="num">{{ row.id }}</div>
                <div class="mono">{{ row.job_id }}</div>
                <div class="truncate" title="{{ row.from_status }} → {{ row.to_status }}">
                  {{ row.from_status }} → {{ row.to_status }}
                </div>
                <div>{{ row.changed_ts | date: "short" }}</div>
                <div class="num">{{ row.pieces_good }}</div>
                <div class="num">{{ row.pieces_scrap }}</div>
              </div>
            } @empty {
              <div class="i40-empty">Keine Log-Einträge vorhanden.</div>
            }
          </div>
        }
      </mat-tab>
    </mat-tab-group>
  }
</div>
